{% extends "layout.html" %}
{% block title %}My Orders · Indian Food App{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">My Orders</h3>
  <div class="d-flex gap-2">
    <a href="{{ url_for('menu') }}" class="btn btn-outline-secondary btn-sm">Menu</a>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">Logout</a>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for c,m in messages %}
      <div class="alert alert-{{ c }}">{{ m }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if orders|length == 0 %}
  <div class="alert alert-info">You haven't placed any orders yet.</div>
{% else %}
  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Items</th>
          <th>Total</th>
          <th>Placed At</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% set map = {
          'pending':'secondary','confirmed':'primary','preparing':'warning',
          'out_for_delivery':'info','ready':'success','delivered':'success','cancelled':'danger'
        } %}
        {% for o in orders %}
          {% set s = (o.status or 'pending')|lower %}
          <tr>
            <td>#{{ o.id }}</td>
            <td><span class="badge bg-{{ map.get(s,'secondary') }}">{{ s.replace('_',' ')|title }}</span></td>
            <td>
              <details>
                <summary>{{ o.items|length }} item(s)</summary>
                <ul class="mb-0 small">
                  {% for it in o.items %}
                    <li>{{ it.name }} × {{ it.qty or 1 }} — {{ it.price|int|vnd }}</li>
                  {% endfor %}
                </ul>
              </details>
            </td>
            <td class="fw-semibold">{{ o.total|vnd }}</td>
            <td><small class="text-muted">{{ o.created_at }}</small></td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('order_detail', order_id=o.id) }}">View</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="3" class="text-end">Paid/Completed Spend:</th>
          <th>{{ total_spent|vnd }}</th>
          <th colspan="2"></th>
        </tr>
      </tfoot>
    </table>
  </div>
{% endif %}
{% endblock %}
