<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Create Order</title>
    <!-- CSS from static -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <header>
      <h1><a href="/">Create Order</a></h1>
      <nav>
        <a href="{{ url_for('menu') }}">Menu</a>
        <a href="{{ url_for('admin_view') }}">Admin</a>
        <a href="{{ url_for('customers_view') }}">Customers</a>
      </nav>
    </header>

    <main>
      <h2>Customer Info</h2>
      <div>
        <label>Name: <input id="custName" placeholder="Ali Khan (default Walk-in)" /></label>
        <label>Phone: <input id="custPhone" placeholder="0300-1234567" /></label>
      </div>

      <h2>Add Items</h2>
      <div>
        <select id="item">
          <option value="" disabled selected>— Select item —</option>
          {% for it in items %}
            <option value="{{ it.id }}" data-price="{{ it.price }}">
              {{ it.name }} — {{ it.price }} VND
            </option>
          {% endfor %}
        </select>
        <input id="qty" type="number" min="1" value="1" />
        <button id="add">Add</button>
      </div>

      <table id="cartTable">
        <thead><tr><th>#</th><th>Item</th><th>Qty</th><th>Price each</th><th>Line total</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="total">Total: <span id="grand">0</span> VND</div>
      <button id="submit">Submit Order</button>
      <div id="msg"></div>
    </main>

    <script>
      const items = {{ items|tojson }};
      const cart = [];
      const sel = document.getElementById('item');
      const qty = document.getElementById('qty');
      const nameInput = document.getElementById('custName');
      const phoneInput = document.getElementById('custPhone');
      const addBtn = document.getElementById('add');
      const tableBody = document.querySelector('#cartTable tbody');
      const grand = document.getElementById('grand');
      const msg = document.getElementById('msg');

      function render() {
        tableBody.innerHTML = '';
        let total = 0;
        cart.forEach((c, i) => {
          const line = c.qty * c.price;
          total += line;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${c.name}</td><td>${c.qty}</td><td>${c.price}</td><td>${line}</td>`;
          tableBody.appendChild(tr);
        });
        grand.textContent = total;
      }

      addBtn.onclick = () => {
        const id = parseInt(sel.value);
        if (!id) { alert("Pehlay item select karein"); return; }
        const opt = sel.options[sel.selectedIndex];
        const name = opt.text.split(' — ')[0];
        const price = parseInt(opt.dataset.price);
        const q = parseInt(qty.value || "1");
        if (q <= 0) return;
        cart.push({ menu_item_id: id, name, price, qty: q });
        render();
      };

      document.getElementById('submit').onclick = async () => {
        if (!cart.length) { msg.textContent = "Add at least one item"; return; }
        msg.textContent = "Submitting...";
        const payload = {
          items: cart,
          customer_name: nameInput.value.trim(),
          phone: phoneInput.value.trim()
        };
        try {
          const res = await fetch('/api/orders', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (data.ok) {
            msg.textContent = `Order #${data.order_id} created. Total: ${data.total} VND`;
            cart.length = 0; render(); nameInput.value=''; phoneInput.value='';
          } else {
            msg.textContent = data.error || "Failed";
          }
        } catch (e) { msg.textContent = e.message; }
      };
    </script>
  </body>
</html>